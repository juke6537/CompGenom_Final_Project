---
title: "heatmaps"
author: "Connor Gagen, Julia Keefe, Paloma Peters, Anna Mellizo Kroll, Anna Broerman"
date: "2024-08-13"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reshape)
library(tidyr)
library(tibble)
library(ggplot2)
library(dplyr)
library(pheatmap)
library(readr)
library(tidyverse)
```

# Goal create "heatmaps"to represent gene abundance across time and replicates.
Heatmaps are a very common and powerful way to represent RNAseq data. It shows the 
abundance of each gene, across all samples and shades them in colore
for more or less abundant expression (e.g., red high, blue low). Moreover, a heatmap can
be combined with a "clustering" algorithm to organize the patterns in the data. Finally, 
this also tells you how related samples are. We can do this in two steps:

# (1) cluster our samples to find the relationship across samples
# (2) cluster and overlay heatmap of gene abundance across time of dox exposure

Let's get started with "clustering our samples"
First let's load the data

```{r Loading data}

# load TPM RESULTS: 
load("/scratch/Shares/rinnclass/MASTER_CLASS/STUDENTS/juke6537/MASTER_CLASS/lessons/06_Differential_expression_analyses/results/TPM_results/TPM_results.Rdata")

# laod DESEQ2 results
load("/scratch/Shares/rinnclass/MASTER_CLASS/STUDENTS/juke6537/MASTER_CLASS/lessons/06_Differential_expression_analyses/results/counts_results_DESEQ/DESEQ_results.rdata")

```

# (1) Cluster samples
First step is calculating distance between all samples. Let's start with our
TPM data as these are the values typically used for clustering and heatmaps. 

# Note use of transmute (t) 
# Note log TPM values being used
```{r distance calculation}

# Log-transform the TPM values. 
# This helps deflate spurious and low values - common practice for clustering/heatmaps
log_tpm_matrix <- log2(TPM_filtered + 1)

# Now let's calculate how closely related each sample (time point) is to each other using DIST function.
# We make a vector the length of genes in TPM_filtered. Then use correlation (DIST function) to find similarity.
# For other methods check out dist menu 
?dist

# Let's start with euclidean distance / similarity based on log2 TPM values of genes in TPM_filtered.
distance_matrix <- dist(t(log_tpm_matrix), method = "euclidean")

# Now we use the function : HCLUST ! 
# This performs the hierarchical clustering of each samples relationship
?hclust
# Other forms of clustering as well see menu above for now ward or complete
# Downside of ward is it assumes a circle relationship where as complete is linear - like we have with time.
hc_complete <- hclust(distance_matrix, method = "complete")

# Now we can use plot() to plot the distance calculated in hclust
plot(hc_complete, labels = colnames(log_tpm_matrix), main = "Global TPM Filtered Dendrogram ", sub = "sample relationship by time and replicate after dox treatment")
# Cool we see that samples see to return closer to 0 after 96 hours of dox treatment
# Also that the replicates are more similar than time points - a very good / expected thing 

# Cut tree to limit the clusters 
clusters <- cutree(hc_complete, k = 5)
```

```{r ordered dendrogram}
# Making a dendrogram of hc_complete
dend_hc_complete <- as.dendrogram(hc_complete)


view(dend_hc_complete)

# Reorder the dendrogram based on the clusters created above
dend_hc_complete <- reorder(dend_hc_complete, clusters)

# Plot the reordered dendrogram
plot(dend_hc_complete, main = "Global TPM Filtered Dendrogram (Ordered by Cluster)", sub = "Sample relationship by time and replicate after dox treatment")

# Voila they are ordered now - not still takes into consideration similarity when ordering !
```

```{r Create Heat map of all filtered TPM genes across all time points and replicates}
# Mapping gene IDs to gene names
gene_labels <- c(
  "ENSMUSG00000064357.1" = "mt-Atp6",
  "ENSMUSG00000000031.16" = "H19",
  "ENSMUSG00000050621.7" = "Rps27rt"
)

# Subset the log_tpm_matrix to include only the genes of interest using their gene IDs
log_tpm_subset <- log_tpm_matrix[rownames(log_tpm_matrix) %in% names(gene_labels), ]

# Rename row names to gene names using gene_labels
rownames(log_tpm_subset) <- gene_labels[rownames(log_tpm_subset)]


custom_dist <- function(x) dist(x, method = "manhattan") # Replace "manhattan" with your preferred method
custom_hclust <- function(x) hclus


# Create the heatmap with the subset of genes
deseq_samples$time_point <- factor(deseq_samples$time_point, levels = c("0", "12", "24", "48", "96"))

# Reorder deseq_samples by time_point
deseq_samples <- deseq_samples[order(deseq_samples$time_point), ]

# Reorder the TPM matrix columns based on the new sample order
log_tpm_subset_ordered <- log_tpm_subset[, deseq_samples$sample_id]

# Generate the heatmap
pheatmap(log_tpm_subset_ordered, 
         cluster_rows = TRUE,  
         cluster_cols = FALSE,  # Disable clustering for columns to preserve order
         scale = "row",        
         show_rownames = TRUE, 
         show_colnames = TRUE,  
         main = "Heatmap of Log2-Transformed TPM Values for Selected Genes",
         color = colorRampPalette(c("blue", "white", "red"))(50))

```

